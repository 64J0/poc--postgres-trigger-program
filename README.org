#+TITLE: [POC] Postgres trigger program
#+DATE: [2024-12-26 qui]

The idea it to create an HTTP Rest API to interact with the user.

This user will be able to POST requests scheduling the execution of
programs. This will be mapped into a database (PostgreSQL) table so we keep the
history of those operations.

Other than this, the user will be able to:

- Register new scripts;
- List scripts that are already registered.

Then, whenever this execution table is updated it will notify a second
application, running a MailboxProcessor that will be responsible for running
these scripts and collecting their output (both success and failure).

Some useful links:

- https://www.postgresql.org/docs/current/sql-notify.html
- https://www.npgsql.org/doc/wait.html
- https://tedeh.net/publishing-rabbitmq-messages-from-postgresql/
- https://thesharperdev.com/fsharps-mailboxprocessor/
- https://en.wikibooks.org/wiki/F_Sharp_Programming/MailboxProcessor

Something to improve error handling later:

- https://paul.blasuc.ci/posts/fault-report.html

** How to run

#+BEGIN_SRC bash :tangle no
  # 1st shell
  #
  # start the database container with
  docker compose up -d postgres

  # if you need to restart it use
  #
  # docker compose down
  # docker compose up -d postgres
  #
  # check the logs with
  #
  # docker container logs -f postgres_container

  # Start the API with
  dotnet run --define:DEBUG --project api/

  # ===============================================
  # 2nd shell
  #
  # start the manager process
  dotnet run --define:DEBUG --project manager/

  # ===============================================
  # 3rd shell
  #
  # start playing with the API and check the logs from the manager process
  curl \
    -d '{"name":"placeholder_001", "dockerImage":"poc_api_2:latest", "createdAt":"2024-01-01"}' \
    -H "Content-Type: application/json" \
    -X POST \
    http://localhost:5000/api/program

  curl http://localhost:5000/api/programs

  curl \
    -d '{"name":"placeholder_001", "programInput":"1 2 3", "createdAt":"2024-01-02"}' \
    -H "Content-Type: application/json" \
    -X POST \
    http://localhost:5000/api/execute

  curl http://localhost:5000/api/executions
#+END_SRC
